/**
 * plugin.js
 *
 * Copyright, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */

/*jshint unused:false */
/*global tinymce:true */

/**
 * oembed plugin that adds a toolbar button and menu item. 
 */
var $id_generator = 0;
tinymce.PluginManager.add('questions', function (editor, url) {
    // Add a button that opens a window
    editor.addButton('questions', {
        text: '? Insert question',
        tooltip: 'To place instructions or other text above or below your test question, just insert your cursor where you want the text and type your instructions. You can also add a document, video, or image.',
        icon: false,
        onclick: function () {
            openQuestionDialog(editor, null);
        }
    });

    // Adds a menu item to the tools menu
    editor.addMenuItem('questions', {
        text: '? Insert question',
        tooltip: 'To place instructions or other text above or below your test question, just insert your cursor where you want the text and type your instructions. You can also add a document, video, or image.',
        context: 'insert',
        onclick: function () {
            // Open window with a specific url
            openQuestionDialog(editor, null);
        }
    });


    jQuery(document).keydown(function(e) {
        if (e.keyCode == 27) { // escape key maps to keycode `27`
            jQuery(".mce-close").trigger("click");
            removeCurrectClassForm();
        }
    });
    jQuery(window).load(function(){
        attachEditButtonClickEvent();
    });

});


var question_num = 0;
function openQuestionDialog(editor, data){
    // check it is a new question or not?
    if(data == null){ //new question
        openNewQuestionDialog(editor);
    } else { //editing question
        openEditQuestionDialog(editor, data);
    }
}

function openNewQuestionDialog(editor){
    // Open window
    openDialog(editor);
    jQuery('.mce-close').click(function(e){
        removeCurrectClassForm();
    });
    jQuery('[name=question_type]').on("change", function () {
        var $el = jQuery(this);
        var data = {};
        data.question_type = $el.attr('id');
        
        data.question_statement = '';
        data.option1 = '';
        data.option2 = '';
        data.option3 = '';
        data.option4 = '';
        data.option5 = '';
        data.response_option1 = '';
        data.response_option2 = '';
        data.response_option3 = '';
        data.response_option4 = '';
        data.response_option5 = '';
        data.correct_option = '';
        data.questionid = '';
        
        
        selectQuestionType(editor, data);
    });

    jQuery('#question_form').on("submit", function (e) {
        e.preventDefault();
        var question_form_this =jQuery(this);
        
        
        var submit = validateQuestionForm(question_form_this);
        if(submit == false){
            return submit;
        }

        // finding correct in case of empty

        var correct = jQuery('input[name=correct_answer]:checked').val();
        var empty = 0;
        for (var i = 1; i <= correct; i++){
            if(jQuery('#answer_'+i).val() == ''){
                empty++;
            }
        }
        correct -= empty;

        // question type handle
        var question_type = jQuery('[name=question_type]:checked').val();



        question_num++;
        $html = '';
        $html = '<div class="question_wrapper">';
            $html += '<form class="question_front_form">';
                $html += '<input type="hidden" name="question_num" value="'+question_num+'">';
                $html += '<div class="question_frontend_statement">';
                    $html += '<h4>';
                        $html += '<span class="question">';
                            $html += escapeHtml(jQuery('#question_statement').val());
                        $html += '</span>';
                        $html += '<span class="display_none edit_question_link" style="text-decoration:underline;cursor:pointer;">';
                        $html += 'Edit';
                        $html += '</span>';
                    $html += '</h4>';
                $html += '</div>';
                $html += '<div class="question_frontend_options">';
                    $html += '<div class="frontend_option">';
                        $html += '<label>';
                            $html += '<input type="radio" name="option" value="1" id="option1">';
                            $html += '<span class="option_val">'+escapeHtml(jQuery('#answer_1').val())+'<span>';
                        $html += '</label>';
                    $html += '</div>';
                    $html += '<div id="response_option1" style="display:none;" class="frontend_response">';
                        $html += escapeHtml(jQuery('#answer_selection_1').val());
                    $html += '</div>';
                    $html += '<div class="frontend_option">';
                        $html += '<label>';
                            $html += '<input type="radio" name="option" value="2" id="option2">';
                            $html += '<span class="option_val">'+escapeHtml(jQuery('#answer_2').val())+'<span>';
                        $html += '</label>';
                    $html += '</div>';
                    $html += '<div id="response_option2" style="display:none;" class="frontend_response">';
                        $html += escapeHtml(jQuery('#answer_selection_2').val());
                    $html += '</div>';
                    if(jQuery('#answer_3').val() != '' && jQuery('#answer_3').length != 0){
                        $html += '<div class="frontend_option">';
                            $html += '<label>';
                                $html += '<input type="radio" name="option" value="3" id="option3">';
                                $html += '<span class="option_val">'+escapeHtml(jQuery('#answer_3').val())+'<span>';
                            $html += '</label>';
                        $html += '</div>';
                        $html += '<div id="response_option3" style="display:none;" class="frontend_response">';
                            $html += escapeHtml(jQuery('#answer_selection_3').val());
                        $html += '</div>';
                    }

                    if(jQuery('#answer_4').val() != '' && jQuery('#answer_4').length != 0){
                        $html += '<div class="frontend_option">';
                            $html += '<label>';
                                $html += '<input type="radio" name="option" value="4" id="option4">';
                                $html += '<span class="option_val">'+escapeHtml(jQuery('#answer_4').val())+'<span>';
                            $html += '</label>';
                        $html += '</div>';
                        $html += '<div id="response_option4" style="display:none;" class="frontend_response">';
                            $html += escapeHtml(jQuery('#answer_selection_4').val());
                        $html += '</div>';
                    }

                    if(jQuery('#answer_5').val() != '' && jQuery('#answer_5').length != 0){
                        $html += '<div class="frontend_option">';
                            $html += '<label>';
                                $html += '<input type="radio" name="option" value="5" id="option5">';
                                $html += '<span class="option_val">'+escapeHtml(jQuery('#answer_5').val())+'<span>';
                            $html += '</label>';
                        $html += '</div>';
                        $html += '<div id="response_option5" style="display:none;" class="frontend_response">';
                            $html += escapeHtml(jQuery('#answer_selection_5').val());
                        $html += '</div>';
                    }

                $html += '</div>';
                $html += '<div class="correct_option" style="display:none;">';
                    $html += correct;
                $html += '</div>';
                $html += '<div class="question_type" style="display:none;">';
                    $html += question_type;
                $html += '</div>';
                $html += '<input type="hidden" class="questionid" name="questionid" value="'+jQuery('.questionid_form').val()+'" />';
                $html += '<div class="question_frontend_submit_wrapper">';
                    $html += '<input type="submit" name="question_frontend_submit" value="Check Answer">';
                $html += '</div>';
            $html += '</form>';    
        $html += '</div>';
        $html += '<div>&nbsp;</div>';
        if(jQuery("#questions").length == 0) {
            jQuery('<input>').attr({
                type: 'hidden',
                id: 'questions',
                name: 'questions[]'
            }).appendTo('#create_resource_form');
        }
        var $q = [];
        var $a = {};
        var prev_questions_obj = [];
        if(jQuery('#questions').val() != ""){
            var prev_questions = jQuery('#questions').val();
            prev_questions_obj = JSON.parse(prev_questions);
            prev_questions_obj.forEach(function(item, index){
                $q.push(item);
            });
        }
//        $q.push(prev_questions_obj);
        $a.question_statement = jQuery('#question_statement').val();
        $a.answer_1 = jQuery('#answer_1').val();
        $a.answer_2 = jQuery('#answer_2').val();
        $a.answer_3 = jQuery('#answer_3').val();
        $a.answer_4 = jQuery('#answer_4').val();
        $a.answer_5 = jQuery('#answer_5').val();
        $a.answer_selection_1 = jQuery('#answer_selection_1').val();
        $a.answer_selection_2 = jQuery('#answer_selection_2').val();
        $a.answer_selection_3 = jQuery('#answer_selection_3').val();
        $a.answer_selection_4 = jQuery('#answer_selection_4').val();
        $a.answer_selection_5 = jQuery('#answer_selection_5').val();
        $a.correct_answer = jQuery('input[name=correct_answer]:checked').val();
        $a.questionid_form = jQuery('.questionid_form').val();

        $q.push($a);

        jQuery('#questions').val(JSON.stringify($q));
        editor.insertContent($html);

        attachEditButtonClickEvent();
    });

}
function openEditQuestionDialog(editor, data, $old_contents, question_front_form){
    var $old_html = jQuery('<div />',{html:$old_contents});
//    $old_html.find('label').html("whatever");
    // Open window
    openDialog(editor);
    if(data.question_type == 'mcq'){
        jQuery('.true_false_selection').hide();
    } else {
        jQuery('.mcq_selection').hide();
    }
    
    jQuery('.mce-close').click(function(e){
        var iframe = jQuery('#elm1_ifr').contents();
        iframe.find(".question_front_form").removeClass('current');
    });
    selectQuestionType(editor, data);
    jQuery('[name=question_type]').on("change", function () {
        var $el = jQuery(this);
        var question_type = $el.attr('id');
        selectQuestionType(editor, data);
    });

    
    jQuery('#question_form').on("submit", function (e) {
        e.preventDefault();
        var question_form_this =jQuery(this);
        
        var submit = validateQuestionForm(question_form_this);
        if(submit == false){
            return submit;
        }

        // finding correct in case of empty

        var correct = jQuery('input[name=correct_answer]:checked').val();
        var empty = 0;
        for (var i = 1; i <= correct; i++){
            if(jQuery('#answer_'+i).val() == ''){
                empty++;
            }
        }
        correct -= empty;

        // question type handle
        var question_type = jQuery('[name=question_type]:checked').val();



        question_num++;
        $html = '';
        $html += '<form class="question_front_form">';
            $html += '<input type="hidden" name="question_num" value="'+question_num+'">';
            $html += '<div class="question_frontend_statement">';
                $html += '<h4>';
                    $html += '<span class="question">';
                        $html += escapeHtml(jQuery('#question_statement').val());
                    $html += '</span>';
                    $html += '<span class="display_none edit_question_link" style="text-decoration:underline;cursor:pointer; display:inline-block;margin-left:10px;">';
                    $html += 'Edit';
                    $html += '</span>';
                $html += '</h4>';
            $html += '</div>';
            $html += '<div class="question_frontend_options">';
                $html += '<div class="frontend_option">';
                    $html += '<label>';
                        $html += '<input type="radio" name="option" value="1" id="option1">';
                        $html += '<span class="option_val">'+escapeHtml(jQuery('#answer_1').val())+'</span>';
                    $html += '</label>';
                $html += '</div>';
                $html += '<div id="response_option1" style="display:none;" class="frontend_response">';
                    $html += escapeHtml(jQuery('#answer_selection_1').val());
                $html += '</div>';
                $html += '<div class="frontend_option">';
                    $html += '<label>';
                        $html += '<input type="radio" name="option" value="2" id="option2">';
                        $html += '<span class="option_val">'+escapeHtml(jQuery('#answer_2').val())+'</span>';
                    $html += '</label>';
                $html += '</div>';
                $html += '<div id="response_option2" style="display:none;" class="frontend_response">';
                    $html += escapeHtml(jQuery('#answer_selection_2').val());
                $html += '</div>';
                if(jQuery('#answer_3').val() != '' && jQuery('#answer_3').length != 0){
                    $html += '<div class="frontend_option">';
                        $html += '<label>';
                            $html += '<input type="radio" name="option" value="3" id="option3">';
                            $html += '<span class="option_val">'+escapeHtml(jQuery('#answer_3').val())+'</span>';
                        $html += '</label>';
                    $html += '</div>';
                    $html += '<div id="response_option3" style="display:none;" class="frontend_response">';
                        $html += escapeHtml(jQuery('#answer_selection_3').val());
                    $html += '</div>';
                }

                if(jQuery('#answer_4').val() != '' && jQuery('#answer_4').length != 0){
                    $html += '<div class="frontend_option">';
                        $html += '<label>';
                            $html += '<input type="radio" name="option" value="4" id="option4">';
                            $html += '<span class="option_val">'+escapeHtml(jQuery('#answer_4').val())+'<span>';
                        $html += '</label>';
                    $html += '</div>';
                    $html += '<div id="response_option4" style="display:none;" class="frontend_response">';
                        $html += escapeHtml(jQuery('#answer_selection_4').val());
                    $html += '</div>';
                }

                if(jQuery('#answer_5').val() != '' && jQuery('#answer_5').length != 0){
                    $html += '<div class="frontend_option">';
                        $html += '<label>';
                            $html += '<input type="radio" name="option" value="5" id="option5">';
                            $html += '<span class="option_val">'+escapeHtml(jQuery('#answer_5').val())+'<span>';
                        $html += '</label>';
                    $html += '</div>';
                    $html += '<div id="response_option5" style="display:none;" class="frontend_response">';
                        $html += escapeHtml(jQuery('#answer_selection_5').val());
                    $html += '</div>';
                }

            $html += '</div>';
            $html += '<div class="correct_option" style="display:none;">';
                $html += correct;
            $html += '</div>';
            $html += '<div class="question_type" style="display:none;">';
                $html += question_type;
            $html += '</div>';
            $html += '<input type="hidden" class="questionid" name="questionid" value="'+jQuery('.questionid_form').val()+'" />';
            $html += '<div class="question_frontend_submit_wrapper">';
                $html += '<input type="submit" name="question_frontend_submit" value="Check Answer">';
            $html += '</div>';
        $html += '</form>';    
        if(jQuery("#questions").length == 0) {
            jQuery('<input>').attr({
                type: 'hidden',
                id: 'questions',
                name: 'questions[]'
            }).appendTo('#create_resource_form');
        }
        var $q = [];
        var $a = {};
        var prev_questions_obj = [];
        if(jQuery('#questions').val() != ""){
            var prev_questions = jQuery('#questions').val();
            prev_questions_obj = JSON.parse(prev_questions);
            prev_questions_obj.forEach(function(item, index){
                $q.push(item);
            });
        }
//        $q.push(prev_questions_obj);
        $a.question_statement = jQuery('#question_statement').val();
        $a.answer_1 = jQuery('#answer_1').val();
        $a.answer_2 = jQuery('#answer_2').val();
        $a.answer_3 = jQuery('#answer_3').val();
        $a.answer_4 = jQuery('#answer_4').val();
        $a.answer_5 = jQuery('#answer_5').val();
        $a.answer_selection_1 = jQuery('#answer_selection_1').val();
        $a.answer_selection_2 = jQuery('#answer_selection_2').val();
        $a.answer_selection_3 = jQuery('#answer_selection_3').val();
        $a.answer_selection_4 = jQuery('#answer_selection_4').val();
        $a.answer_selection_5 = jQuery('#answer_selection_5').val();
        $a.correct_answer = jQuery('input[name=correct_answer]:checked').val();
        $a.questionid_form = jQuery('.questionid_form').val();

        $q.push($a);

        jQuery('#questions').val(JSON.stringify($q));
        

        $old_html.find('.question_front_form.current').replaceWith($html);
        $old_html.append("<div>&nbsp;</div>");
        editor.setContent($old_html.html());
        tinyMCE.activeEditor.selection.select(tinyMCE.activeEditor.getBody(), true);
        tinyMCE.activeEditor.selection.collapse(false);

        attachEditButtonClickEvent();
    });
}
function openDialog(editor){
    editor.windowManager.open({
        title: 'Insert question',
        classes: 'questions',
        width: 700,
        html:
                '<div id="mm-attrs-pop" class="mm-tinymce-popup" tabindex="-1">' +
                "<form id='question_form'>" +
                "<h3>Question Type</h3>" +
                "<div class='true_false_selection' style='display:inline-block;'>" +
                    "<input type='radio' name='question_type' id='true_false' value='true_false' /><label for='true_false'>True/false</label>" +
                "</div>"+
                "<div class='mcq_selection' style='display:inline-block;'>" +
                "<input type='radio' name='question_type' id='mcq' value='mcq' /><label for='mcq'>Multiple Choice</label>" +
                "</div>"+
                "<div id='question_body'></div>"+
                "</form>" +
                '</div>',
        buttons: [],
        autoScroll: true,
        scrollbars:true,
        resizable : "yes"
    });
    
    //style window
    jQuery('.mce-container-body').css({"height": 'inherit'});
}
function selectQuestionType(editor, data) {
    jQuery('#'+data.question_type).prop("checked", true);
    
    if(data.question_type == 'true_false'){
        var true_false_html = true_false_form(data);
        jQuery('#question_body').html(true_false_html);
        
        // populating form
        
        jQuery('#answer_selection_1').val(data.response_option1);
        jQuery('#answer_selection_2').val(data.response_option2);
        jQuery('.questionid_form').val(data.questionid);
        
        if(data.correct_option != ''){
            jQuery('[name=correct_answer][value='+data.correct_option+']').prop("checked",true);
        }
    } else if(data.question_type == 'mcq'){
        var mcq_form_html = mcq_form(data);
        jQuery('#question_body').html(mcq_form_html);
        
        // populating form
        jQuery('#answer_1').val(data.option1);
        jQuery('#answer_2').val(data.option2);
        jQuery('#answer_3').val(data.option3);
        jQuery('#answer_4').val(data.option4);
        jQuery('#answer_5').val(data.option5);
        jQuery('#answer_selection_1').val(data.response_option1);
        jQuery('#answer_selection_2').val(data.response_option2);
        jQuery('#answer_selection_3').val(data.response_option3);
        jQuery('#answer_selection_4').val(data.response_option4);
        jQuery('#answer_selection_5').val(data.response_option5);
        jQuery('.questionid_form').val(data.questionid);
        
        if(data.correct_option != ''){
            jQuery('[name=correct_answer][value='+data.correct_option+']').prop("checked",true);
        }
    }
    
    
    jQuery('[name=correct_answer]').parent().append('<span class="question-tooltip tooltip fa fa-question-circle" data-hasqtip="0">&nbsp;</span>');
    jQuery('.question-tooltip').qtip({
        content: {
            text: "If an incorrect answer is selected the text you enter as 'Response to selecting this answer.' will display followed by 'Your answer was incorrect. Please try again.\n<br /><br />\
If a correct answer is selected the text you enter as 'Response to selecting this answer.' will display followed by 'Congratulations. You selected the correct answer.'"
        },
        style: {classes: 'qtipCustomClass forceZIndexQtip'}
    });
}


function mcq_form(data){
    var mcq_html = '';
    mcq_html += "<h4>Question</h4>";
    mcq_html += "<div class='question-box'>";
    mcq_html += "<textarea placeholder='Enter question here' id='question_statement' class='required' name='question_statement' style='resize:none;white-space: normal;'>"+data.question_statement+"</textarea>";
    mcq_html += "</div>";
    mcq_html += "<div class='options-box'>";
    mcq_html += "<table class='table table-striped' style='width:100%'>";
        if(data.questionid == '' || (data.questionid != '' && data.response_option1 != '')){
            mcq_html += "<tr>";
                mcq_html += "<td>";
                    mcq_html += "<label for='answer_1'>1</label>";
                mcq_html += "</td>";
                mcq_html += "<td>";
                    mcq_html += "<input type='text' name='answer_1' id='answer_1' placeholder='Enter Answer' class='answer required' value='' />";
                mcq_html += "</td>";
                mcq_html += "<td>";
                    mcq_html += "<input type='text' name='answer_selection_1' id='answer_selection_1' placeholder='Response to selecting this answer.' class='answer_selection required' value='' />";
                mcq_html += "</td>";
                mcq_html += "<td>";
                    mcq_html += "<input type='radio' name='correct_answer' id='correct_answer_1' value='1'  /> <label for='correct_answer_1'>Correct</label>";
                mcq_html += "</td>";
            mcq_html += "</tr>";
        }
        if(data.questionid == '' || (data.questionid != '' && data.response_option2 != '')){
            mcq_html += "<tr>";
                mcq_html += "<td>";
                    mcq_html += "<label for='answer_2'>2</label>";
                mcq_html += "</td>";
                mcq_html += "<td>";
                    mcq_html += "<input type='text' name='answer_2' id='answer_2' placeholder='Enter Answer' class='answer required' value='' />";
                mcq_html += "</td>";
                mcq_html += "<td>";
                    mcq_html += "<input type='text' name='answer_selection_2' id='answer_selection_2' placeholder='Response to selecting this answer.' class='answer_selection required' value='' />";
                mcq_html += "</td>";
                mcq_html += "<td>";
                    mcq_html += "<input type='radio' name='correct_answer' id='correct_answer_2' value='2' /> <label for='correct_answer_2'>Correct</label>";
                mcq_html += "</td>";
            mcq_html += "</tr>";
        }
        if(data.questionid == '' || (data.questionid != '' && data.response_option3 != '')){
            mcq_html += "<tr>";
                mcq_html += "<td>";
                    mcq_html += "<label for='answer_3'>3</label>";
                mcq_html += "</td>";
                if(data.questionid == ''){
                    mcq_html += "<td>";
                        mcq_html += "<input type='text' name='answer_3' id='answer_3' placeholder='Enter Answer' class='answer' value='' />";
                    mcq_html += "</td>";
                    mcq_html += "<td>";
                        mcq_html += "<input type='text' name='answer_selection_3' id='answer_selection_3' placeholder='Response to selecting this answer.' class='answer_selection' value='' />";
                    mcq_html += "</td>";
                } else {
                    mcq_html += "<td>";
                        mcq_html += "<input type='text' name='answer_3' id='answer_3' placeholder='Enter Answer' class='answer required' value='' />";
                    mcq_html += "</td>";
                    mcq_html += "<td>";
                        mcq_html += "<input type='text' name='answer_selection_3' id='answer_selection_3' placeholder='Response to selecting this answer.' class='answer_selection required' value='' />";
                    mcq_html += "</td>";
                }
                mcq_html += "<td>";
                    mcq_html += "<input type='radio' name='correct_answer' id='correct_answer_3' value='3'  /> <label for='correct_answer_3'>Correct</label>";
                mcq_html += "</td>";
            mcq_html += "</tr>";
        }
        if(data.questionid == '' || (data.questionid != '' && data.response_option4 != '')){
            mcq_html += "<tr>";
                mcq_html += "<td>";
                    mcq_html += "<label for='answer_4'>4</label>";
                mcq_html += "</td>";
                if(data.questionid == ''){
                    mcq_html += "<td>";
                        mcq_html += "<input type='text' name='answer_4' id='answer_4' placeholder='Enter Answer' class='answer' value='' />";
                    mcq_html += "</td>";
                    mcq_html += "<td>";
                        mcq_html += "<input type='text' name='answer_selection_4' id='answer_selection_4' placeholder='Response to selecting this answer.' class='answer_selection' value='' />";
                    mcq_html += "</td>";
                } else {
                    mcq_html += "<td>";
                        mcq_html += "<input type='text' name='answer_4' id='answer_4' placeholder='Enter Answer' class='answer required' value='' />";
                    mcq_html += "</td>";
                    mcq_html += "<td>";
                        mcq_html += "<input type='text' name='answer_selection_4' id='answer_selection_4' placeholder='Response to selecting this answer.' class='answer_selection required' value='' />";
                    mcq_html += "</td>";
                }
                mcq_html += "<td>";
                    mcq_html += "<input type='radio' name='correct_answer' id='correct_answer_4' value='4'  /> <label for='correct_answer_4'>Correct</label>";
                mcq_html += "</td>";
            mcq_html += "</tr>";
        }
        
        if(data.questionid == '' || (data.questionid != '' && data.response_option5 != '')){
            mcq_html += "<tr>";
                mcq_html += "<td>";
                    mcq_html += "<label for='answer_5'>5</label>";
                mcq_html += "</td>";
                if(data.questionid == ''){
                    mcq_html += "<td>";
                        mcq_html += "<input type='text' name='answer_5' id='answer_5' placeholder='Enter Answer' class='answer' value='' />";
                    mcq_html += "</td>";
                    mcq_html += "<td>";
                        mcq_html += "<input type='text' name='answer_selection_5' id='answer_selection_5' placeholder='Response to selecting this answer.' class='answer_selection' value='' />";
                    mcq_html += "</td>";
                } else {
                    mcq_html += "<td>";
                        mcq_html += "<input type='text' name='answer_5' id='answer_5' placeholder='Enter Answer' class='answer required' value='' />";
                    mcq_html += "</td>";
                    mcq_html += "<td>";
                        mcq_html += "<input type='text' name='answer_selection_5' id='answer_selection_5' placeholder='Response to selecting this answer.' class='answer_selection required' value='' />";
                    mcq_html += "</td>";
                }
                mcq_html += "<td>";
                    mcq_html += "<input type='radio' name='correct_answer' id='correct_answer_5' value='5'  /> <label for='correct_answer_5'>Correct</label>";
                mcq_html += "</td>";
            mcq_html += "</tr>";
        }
    mcq_html += "</table>";
    mcq_html += "</div>";
    mcq_html += '<input type="hidden" class="questionid_form" name="questionid_form" value="" />';
    mcq_html += "<input type='submit' value='Ok' style='background-color: #257cb6;' />";
    return mcq_html;
}

function true_false_form(data){
    var true_false_html = '';
    true_false_html += "<h4>Question</h4>";
    true_false_html += "<div class='question-box'>";
    true_false_html += "<textarea placeholder='Enter question here' id='question_statement' name='question_statement' class='required' style='resize:none;white-space: normal;'>"+data.question_statement+"</textarea>";
    true_false_html += "</div>";
    true_false_html += "<div class='options-box'>";
    true_false_html += "<table class='table table-striped' style='width:100%'>";
        true_false_html += "<tr>";
            true_false_html += "<td>";
                true_false_html += "<label for='answer_1'>1</label>";
            true_false_html += "</td>";
            true_false_html += "<td>";
                true_false_html += "<input type='text' name='answer_1' id='answer_1' placeholder='Enter Answer' class='answer required' value='True' readonly />";
            true_false_html += "</td>";
            true_false_html += "<td>";
                true_false_html += "<input type='text' name='answer_selection_1' id='answer_selection_1' placeholder='Response to selecting this answer.' class='answer_selection required' value='' />";
            true_false_html += "</td>";
            true_false_html += "<td>";
                true_false_html += "<input type='radio' name='correct_answer' id='correct_answer_1' value='1'  /> <label for='correct_answer_1'>Correct</label>";
            true_false_html += "</td>";
        true_false_html += "</tr>";
        true_false_html += "<tr>";
            true_false_html += "<td>";
                true_false_html += "<label for='answer_2'>2</label>";
            true_false_html += "</td>";
            true_false_html += "<td>";
                true_false_html += "<input type='text' name='answer_2' id='answer_2' placeholder='Enter Answer' class='answer required' value='False' readonly />";
            true_false_html += "</td>";
            true_false_html += "<td>";
                true_false_html += "<input type='text' name='answer_selection_2' id='answer_selection_2' placeholder='Response to selecting this answer.' class='answer_selection required' value='' />";
            true_false_html += "</td>";
            true_false_html += "<td>";
                true_false_html += "<input type='radio' name='correct_answer' id='correct_answer_2' value='2' /> <label for='correct_answer_2'>Correct</label>";
            true_false_html += "</td>";
        true_false_html += "</tr>";
    true_false_html += "</table>";
    true_false_html += "</div>";
    true_false_html += '<input type="hidden" class="questionid_form" name="questionid_form" value="" />';
    true_false_html += "<input type='submit' value='Ok' style='background-color: #257cb6;' />";
    return true_false_html;
}

var entityMap = {
  '&': '&amp;',
  '<': '&lt;',
  '>': '&gt;',
  '"': '&quot;',
  "'": '&#39;',
  '/': '&#x2F;',
  '`': '&#x60;',
  '=': '&#x3D;'
};

function escapeHtml (string) {
  return String(string).replace(/[&<>"'`=\/]/g, function (s) {
    return entityMap[s];
  });
}


function attachEditButtonClickEvent(){
    var iframe = jQuery('#elm1_ifr').contents();
    iframe.find(".edit_question_link").unbind().click(function(){
        var edit_question_link = jQuery(this);
        var question_front_form= edit_question_link.parent().closest('.question_front_form');

        question_front_form.addClass('current');

        var data = {};
        var $old_contents = tinyMCE.activeEditor.getContent({format : 'raw'});
        var template = jQuery.parseHTML($old_contents);

        data.question_type = question_front_form.find('.question_type').html();
        data.question_statement = question_front_form.find('.question_frontend_statement h4 .question').html();

        data.option1 = question_front_form.find('#option1').next().text();
        data.option2 = question_front_form.find('#option2').next().text();
        data.option3 = question_front_form.find('#option3').next().text();
        data.option4 = question_front_form.find('#option4').next().text();
        data.option5 = question_front_form.find('#option5').next().text();
        data.response_option1 = question_front_form.find('#response_option1').text();
        data.response_option2 = question_front_form.find('#response_option2').text();
        data.response_option3 = question_front_form.find('#response_option3').text();
        data.response_option4 = question_front_form.find('#response_option4').text();
        data.response_option5 = question_front_form.find('#response_option5').text();
        data.correct_option = question_front_form.find('.correct_option').text();
        data.questionid = question_front_form.find('.questionid').val();

        if (typeof data.option1 == 'undefined'){
            data.option1 = '';
        }
        if (typeof data.option2 == 'undefined'){
            data.option2 = '';
        }
        if (typeof data.option3 == 'undefined'){
            data.option3 = '';
        }
        if (typeof data.option4 == 'undefined'){
            data.option4 = '';
        }
        if (typeof data.option5 == 'undefined'){
            data.option5 = '';
        }
        if (typeof data.response_option1 == 'undefined'){
            data.response_option1 = '';
        }
        if (typeof data.response_option2 == 'undefined'){
            data.response_option2 = '';
        }
        if (typeof data.response_option3 == 'undefined'){
            data.response_option3 = '';
        }
        if (typeof data.response_option4 == 'undefined'){
            data.response_option4 = '';
        }
        if (typeof data.response_option5 == 'undefined'){
            data.response_option5 = '';
        }
        if (typeof data.correct_option == 'undefined'){
            data.correct_option = '';
        }
        if (typeof data.questionid == 'undefined'){
            data.questionid = '';
        }
           openEditQuestionDialog(tinyMCE.activeEditor, data, $old_contents, question_front_form);
    });
}

function removeCurrectClassForm(){
    var iframe = jQuery('#elm1_ifr').contents();
    iframe.find(".question_front_form").removeClass('current');
}

function validateQuestionForm(question_form_this){
    //validating errors
    var submit = true;
    jQuery('#question_form .error').removeClass('error');


    /* MCQ validation of empty fields in between - Start */

    var answer_selection_space_exists = 0;
    var answer_selection_space_count = 5;

    var empty_answer_selection = [];
    if(jQuery('.answer_selection').each(function(){
        empty_answer_selection.push(jQuery(this).val());
    }));
    for (var i = empty_answer_selection.length - 1; i >= 0 ; i--){
        if(empty_answer_selection[i] == '' && answer_selection_space_exists == 1){
            answer_selection_space_exists = 0;
            break;
        } else if(empty_answer_selection[i] != '') {
            answer_selection_space_exists = 1;
        }
        answer_selection_space_count--;
    }

    if (answer_selection_space_count > 1){
        for(var i = answer_selection_space_count; i >= 1; i--){
            if(jQuery('#answer_selection_'+i).val() == ''){
                jQuery('#answer_selection_'+i).addClass('error');
            }
            if(jQuery('#answer_'+i).val() == ''){
                jQuery('#answer_'+i).addClass('error');
            }
        }
    }
    if(answer_selection_space_exists == 0){
        submit = false;
    } else {
        submit = true;
    }








    var answer_space_exists = 0;
    var answer_space_count = 5;

    var empty_answer = [];
    if(jQuery('input.answer').each(function(){
        empty_answer.push(jQuery(this).val());
    }));
    for (var i = empty_answer.length - 1; i >= 0 ; i--){
        if(empty_answer[i] == '' && answer_space_exists == 1){
            answer_space_exists = 0;
            break;
        } else if(empty_answer[i] != '') {
            answer_space_exists = 1;
        }
        answer_space_count--;
    }

    if (answer_space_count > 1){
        for(var i = answer_space_count; i >= 1; i--){
            if(jQuery('#answer_selection_'+i).val() == ''){
                jQuery('#answer_selection_'+i).addClass('error');
            }
            if(jQuery('#answer_'+i).val() == ''){
                jQuery('#answer_'+i).addClass('error');
            }
        }
    }
    if(answer_space_exists == 0){
        submit = false;
    } else {
        submit = true;
    }

    /* MCQ validation of empty fields in between - End */





    question_form_this.find('.required').each(function(index, element){
        if(!jQuery(this).val()){
            jQuery(this).addClass('error');
            submit = false;
        }
    });



    if(!jQuery('[name=correct_answer]').is(':checked')){
        jQuery('#correct_answer_1').parent().addClass('error');
        submit = false;
    }
    // checking previous question statement and response
    if(jQuery('[name=correct_answer]').is(':checked')){
        if(jQuery('input[name=correct_answer]:checked').parent().prev().find('input').val() == ''){
            jQuery('input[name=correct_answer]:checked').parent().prev().find('input').addClass('error');
            submit = false;
        }
        if(jQuery('input[name=correct_answer]:checked').parent().prev().prev().find('input').val() == ''){
            jQuery('input[name=correct_answer]:checked').parent().prev().prev().find('input').addClass('error');
            submit = false;
        }
    }

    //checking selection answer has text

    if(jQuery('.answer_selection').each(function(){
        if(jQuery(this).val() != ''){
            if(jQuery(this).parent().prev().find('input').val() == ''){
                jQuery(this).parent().prev().find('input').addClass('error');
                submit = false;
            }
        }
    }));
    if(jQuery('.answer').each(function(){
        if(jQuery(this).val() != ''){
            if(jQuery(this).parent().next().find('input').val() == ''){
                jQuery(this).parent().next().find('input').addClass('error');
                submit = false;
            }
        }
    }));

    // Length Validation
    if(question_form_this.find('#question_statement').length != 0 && question_form_this.find('#question_statement').val().length > 500)
    {
        question_form_this.find('#question_statement').addClass('error');
        submit = false;
    }
    if(question_form_this.find('#answer_1').length != 0 && question_form_this.find('#answer_1').val().length > 500)
    {
        question_form_this.find('#answer_1').addClass('error');
        submit = false;
    }
    if(question_form_this.find('#answer_2').length != 0 && question_form_this.find('#answer_2').val().length > 500)
    {
        question_form_this.find('#answer_2').addClass('error');
        submit = false;
    }
    if(question_form_this.find('#answer_3').length != 0 && question_form_this.find('#answer_3').val().length > 500)
    {
        question_form_this.find('#answer_3').addClass('error');
        submit = false;
    }
    if(question_form_this.find('#answer_4').length != 0 && question_form_this.find('#answer_4').val().length > 500)
    {
        question_form_this.find('#answer_4').addClass('error');
        submit = false;
    }
    if(question_form_this.find('#answer_5').length != 0 && question_form_this.find('#answer_5').val().length > 500)
    {
        question_form_this.find('#answer_5').addClass('error');
        submit = false;
    }
    if(question_form_this.find('#answer_selection_1').length != 0 && question_form_this.find('#answer_selection_1').val().length > 500)
    {
        question_form_this.find('#answer_selection_1').addClass('error');
        submit = false;
    }
    if(question_form_this.find('#answer_selection_2').length != 0 && question_form_this.find('#answer_selection_2').val().length > 500)
    {
        question_form_this.find('#answer_selection_2').addClass('error');
        submit = false;
    }
    if(question_form_this.find('#answer_selection_3').length != 0 && question_form_this.find('#answer_selection_3').val().length > 500)
    {
        question_form_this.find('#answer_selection_3').addClass('error');
        submit = false;
    }
    if(question_form_this.find('#answer_selection_4').length != 0 && question_form_this.find('#answer_selection_4').val().length > 500)
    {
        question_form_this.find('#answer_selection_4').addClass('error');
        submit = false;
    }
    if(question_form_this.find('#answer_selection_5').length != 0 && question_form_this.find('#answer_selection_5').val().length > 500)
    {
        question_form_this.find('#answer_selection_5').addClass('error');
        submit = false;
    }
    
    return submit;
}